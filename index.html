<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>USB Thermal Printer Test</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <h2>üñ®Ô∏è USB Thermal Printer Test</h2>
    <button id="print">Connect & Print</button>

    <pre id="log"></pre>

    <script>
      const log = (msg) => {
        document.getElementById("log").textContent += msg + "\n";
      };

      document.getElementById("print").onclick = async () => {
        try {
          log("Requesting USB device...");

          const device = await navigator.usb.requestDevice({
            filters: [], // allow user to pick printer
          });

          log(`Selected device: ${device.productName}`);

          await device.open();

          if (device.configuration === null) {
            await device.selectConfiguration(1);
          }

          await device.claimInterface(0);
          log("Interface claimed");

          // ESC/POS modern receipt design
          const encoder = new TextEncoder();

          const ESC = 0x1b;
          const GS = 0x1d;

          // Predefined strings for clean column alignment (42 columns)
          const headerLine = "==========================================";
          const thinLine = "------------------------------------------";

          // Build the receipt data
          const data = new Uint8Array([
            // Initialize printer
            ESC,
            0x40,

            // ========== HEADER ==========
            // Store name: double width/height + bold + underline
            ESC,
            0x61,
            0x01, // Center align
            ESC,
            0x45,
            0x01, // Bold ON
            GS,
            0x21,
            0x11, // Double width & height
            ESC,
            0x2d,
            0x01, // Underline ON (single)
            ...encoder.encode("MICROBLADE SYS\n"),
            ESC,
            0x2d,
            0x00, // Underline OFF
            GS,
            0x21,
            0x00, // Normal size
            ESC,
            0x45,
            0x00, // Bold OFF

            // Address and contact (normal, center)
            ...encoder.encode("123 Tech Street, Silicon Valley\n"),
            ...encoder.encode("Tel: +1 (702) 322-095\n"),

            // Receipt metadata (left align)
            ESC,
            0x61,
            0x00, // Left align
            ...encoder.encode(
              "Receipt #: 12345          Date: 2025-02-18 14:30\n",
            ),

            // Separator
            ...encoder.encode(headerLine + "\n"),

            // ========== ITEMS TABLE ==========
            // Table header (bold)
            ESC,
            0x45,
            0x01,
            ...encoder.encode(
              "Item                          Qty   Price    Total\n",
            ),
            ESC,
            0x45,
            0x00,
            ...encoder.encode(thinLine + "\n"),

            // Items (carefully spaced for 42 columns)
            ...encoder.encode(
              "USB-C Cable                   1    8.00     8.00\n",
            ),
            ...encoder.encode(
              "Wireless Mouse                 1   15.50    15.50\n",
            ),
            ...encoder.encode(
              "Mechanical Keyboard            1   45.00    45.00\n",
            ),
            ...encoder.encode(
              "Power Bank 20k                  1   32.00    32.00\n",
            ),
            ...encoder.encode(
              "HDMI Adapter                    1    6.50     6.50\n",
            ),

            ...encoder.encode(thinLine + "\n"),

            // Totals (bold, right‚Äëaligned via spaces)
            ESC,
            0x45,
            0x01,
            ...encoder.encode("Subtotal                             107.00\n"),
            ...encoder.encode("VAT (15%)                              16.05\n"),
            ...encoder.encode(thinLine + "\n"),
            ...encoder.encode("TOTAL                                123.05\n"),
            ESC,
            0x45,
            0x00,

            // Payment method
            ...encoder.encode("\nPayment: Cash\n"),
            ...encoder.encode("Change: 0.00\n\n"),

            // ========== FOOTER ==========
            // Thank you message with stars (center)
            ESC,
            0x61,
            0x01,
            ...encoder.encode("‚ú®  THANK YOU FOR SHOPPING  ‚ú®\n"),
            ...encoder.encode("     with MICROBLADE SYS     \n\n"),

            // QR Code (center, encodes website URL)
            // Note: Printer must support QR code printing (Epson/Star compatible)
            // Set QR model (model 2)
            GS,
            0x28,
            0x6b,
            0x04,
            0x00,
            0x31,
            0x41,
            0x32,
            0x00,
            // Set module size (4 dots)
            GS,
            0x28,
            0x6b,
            0x03,
            0x00,
            0x31,
            0x43,
            0x04,
            // Set error correction (level M)
            GS,
            0x28,
            0x6b,
            0x03,
            0x00,
            0x31,
            0x45,
            0x31,
            // Store data: "https://nilevalleylab.com" (length 24)
            // pL = 27 (24+3), pH = 0
            GS,
            0x28,
            0x6b,
            0x1b,
            0x00,
            0x31,
            0x50,
            0x30,
            ...encoder.encode("https://nilevalleylab.com"),
            // Print QR code
            GS,
            0x28,
            0x6b,
            0x03,
            0x00,
            0x31,
            0x51,
            0x30,

            // Spacer
            ...encoder.encode("\n"),

            // Contact & social (center)
            ESC,
            0x61,
            0x01,
            ...encoder.encode("www.nilevalleylab.com\n"),
            ...encoder.encode("üì± @nilevalleylab\n"),
            ...encoder.encode("üìû 0702322095\n\n"),

            // ========== CUT ==========
            // Partial cut (GS V m n) ‚Äì m=1 for partial cut, n=0
            GS,
            0x56,
            0x01,
            0x00,
          ]);

          // // ESC/POS print data
          // const encoder = new TextEncoder();

          // const ESC = 0x1b;
          // const GS = 0x1d;

          // const data = new Uint8Array([
          //   // Initialize
          //   ESC,
          //   0x40,

          //   // Center + Bold + Double size (logo)
          //   ESC,
          //   0x61,
          //   0x01, // Center
          //   ESC,
          //   0x45,
          //   0x01, // Bold ON
          //   GS,
          //   0x21,
          //   0x11, // Double width + height
          //   ...encoder.encode("MICROBLADE SYS\n"),

          //   // Normal size
          //   GS,
          //   0x21,
          //   0x00,
          //   ESC,
          //   0x45,
          //   0x00, // Bold OFF
          //   ...encoder.encode("Electronics Store\n\n"),

          //   // Separator
          //   ESC,
          //   0x61,
          //   0x00, // Left align
          //   ...encoder.encode("--------------------------------\n"),

          //   // Items
          //   ...encoder.encode("USB-C Cable        8.00\n"),
          //   ...encoder.encode("Wireless Mouse    15.50\n"),
          //   ...encoder.encode("Mechanical KB     45.00\n"),
          //   ...encoder.encode("Power Bank 20k    32.00\n"),
          //   ...encoder.encode("HDMI Adapter       6.50\n"),

          //   ...encoder.encode("--------------------------------\n"),

          //   // Totals (bold)
          //   ESC,
          //   0x45,
          //   0x01,
          //   ...encoder.encode("Subtotal         107.00\n"),
          //   ...encoder.encode("VAT (15%)         16.05\n"),
          //   ...encoder.encode("--------------------------------\n"),
          //   ...encoder.encode("TOTAL            123.05\n"),
          //   ESC,
          //   0x45,
          //   0x00,

          //   // Footer
          //   ESC,
          //   0x61,
          //   0x01, // Center align
          //   ...encoder.encode("\nThank you!\n"),
          //   ...encoder.encode("www.nilevalleylab.com\n"),
          //   ...encoder.encode("Designed & Developed by\n"),
          //   ...encoder.encode("Nile Valley Lab\n"),
          //   ...encoder.encode("0702322095\n\n"),

          //   // Cut paper
          //   GS,
          //   0x56,
          //   0x41,
          //   0x10,
          // ]);

          // Endpoint is usually 1 (OUT)
          await device.transferOut(1, data);

          log("‚úÖ Print data sent");

          await device.close();
        } catch (err) {
          console.error(err);
          log("‚ùå ERROR: " + err.message);
        }
      };
    </script>
  </body>
</html>
